<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>graph.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Namespaces</li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="focus.html">focus</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="focus.html#.disable">disable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="focus.html#.display">display</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="focus.html#.hide">hide</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="focus.html#.init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="focus.html#.set">set</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="historique.html">historique</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="historique.html#.actualiser">actualiser</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="historique.html#.init">init</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="view.html">view</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#changeView">changeView</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#closeRecord">closeRecord</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#displayAllFromIndex">displayAllFromIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#displayFromIndex">displayFromIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#displayNodes">displayNodes</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#filter">filter</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getActiveFilterNames">getActiveFilterNames</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getFilterNames">getFilterNames</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getNodesHideByFilter">getNodesHideByFilter</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getUnactiveFilterNames">getUnactiveFilterNames</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#hideAllFromIndex">hideAllFromIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#hideFromIndex">hideFromIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#hideNodes">hideNodes</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#nodeFocus">nodeFocus</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#openRecord">openRecord</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#parseIdsString">parseIdsString</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#registerView">registerView</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#resetFocus">resetFocus</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#saveView">saveView</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#setFilters">setFilters</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#translate">translate</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">graph.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Generate nodes, labels &amp; links for graph. Highlight, hide &amp; display nodes &amp; links. Set mouse events.
 * @author Guillaume Brioudes
 * @copyright MIT License ANR HyperOtlet
 */

(function() {

let link, node, circles, labels
    , simulation = d3.forceSimulation()
    , width = +svg.node().getBoundingClientRect().width
    , height = +svg.node().getBoundingClientRect().height;

d3.select(window).on("resize", function () {
    width = +svg.node().getBoundingClientRect().width;
    height = +svg.node().getBoundingClientRect().height;
    updateForces();
});

initializeDisplay();
initializeSimulation();

/**
 * Set up the simulation and event to update locations after each tick
 */

function initializeSimulation() {
    simulation.nodes(graph.nodes);
    initializeForces();
    simulation.on("tick", ticked);
}

/**
 * Set the forces to the simulation
 */

function initializeForces() {
    // add forces and associate each with a name
    simulation
        .force("link", d3.forceLink())
        .force("charge", d3.forceManyBody())
        .force("collide", d3.forceCollide())
        .force("center", d3.forceCenter())
        .force("forceX", d3.forceX())
        .force("forceY", d3.forceY());
    // apply properties to each of the forces
    updateForces();
}

/**
 * Update the forces to the simulation
 */

function updateForces() {
    // get each force by name and update the properties

    simulation.force("center")
        .x(width * graphProperties.position.x)
        .y(height * graphProperties.position.y);

    simulation.force("charge")
        // turn force value to negative number
        .strength(-Math.abs(graphProperties.attraction.force))
        .distanceMax(graphProperties.attraction.distance_max);

    simulation.force("forceX")
        .strength(graphProperties.attraction.horizontale)

    simulation.force("forceY")
        .strength(graphProperties.attraction.verticale)

    simulation.force("link")
        .id((d) => d.id)
        .links(graph.links);

    // restarts the simulation
    simulation.alpha(1).restart();
}

window.updateForces = updateForces;

function updateGraphTextSize() {
    node.selectAll("text")
        .attr('font-size', graphProperties.text_size);
}

window.updateGraphTextSize = updateGraphTextSize;

/**
 * Initialize visualisation
 */

function initializeDisplay() {

    // set the data and properties of link lines
    link = svg.append("g")
        .attr("class", "links")
        .selectAll("line")
        .data(graph.links)
        .enter().append("line");

    // set the data and properties of node circles
    node = svg.append("g")
        .attr("class", "nodes")
        .selectAll("g")
        .data(graph.nodes)
        .enter().append("g")
        .attr("data-node", (d) => d.id)
        .on('click', function(nodeMetas) {
            openRecord(nodeMetas.id);
        })

    circles = node.append("circle")
        .attr("r", (d) => d.size)
        .attr("class", (d) => "n_" + d.type)
        .call(d3.drag()
            .on("start", function(d) {
                if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y; })
            .on("drag", function(d) {
                d.fx = d3.event.x;
                d.fy = d3.event.y; })
            .on("end", function(d) {
                if (!d3.event.active) simulation.alphaTarget(0.0001);
                d.fx = null;
                d.fy = null; })
        )
        .on('mouseenter', function(nodeMetas) {
            if (!graphProperties.highlight_on_hover) { return; }

            let nodesIdsHovered = [nodeMetas.id];

            const linksToModif = link.filter(function(link) {
                if (link.source.id === nodeMetas.id || link.target.id === nodeMetas.id) {
                    nodesIdsHovered.push(link.source.id, link.target.id);
                    return false;
                }
                return true;
            })

            const nodesToModif = node.filter(function(node) {
                if (nodesIdsHovered.includes(node.id)) {
                    return false;
                }
                return true;
            })

            const linksHovered = link.filter(function(link) {
                if (link.source.id !== nodeMetas.id &amp;&amp; link.target.id !== nodeMetas.id) {
                    return false;
                }
                return true;
            })

            const nodesHovered = node.filter(function(node) {
                if (!nodesIdsHovered.includes(node.id)) {
                    return false;
                }
                return true;
            })

            nodesHovered.classed('hover', true);
            linksHovered.classed('hover', true);
            nodesToModif.classed('translucent', true);
            linksToModif.classed('translucent', true);
        })
        .on('mouseout', function() {
            if (!graphProperties.highlight_on_hover) { return; }

            node.classed('hover', false);
            node.classed('translucent', false);
            link.classed('hover', false);
            link.classed('translucent', false);
        })

    labels = node.append("text")
        .each(function(d) {
            const words = d.label.split(' ')
                , max = 25
                , text = d3.select(this);
            let label = '';

            for (let i = 0; i &lt; words.length; i++) {
                // combine words and seperate them by a space caracter into label
                label += words[i] + ' ';

                // if label (words combination) is longer than max &amp; not the single iteration
                if (label.length &lt; max &amp;&amp; i !== words.length - 1) { continue; }

                text.append("tspan")
                    .attr('x', 0)
                    .attr('dy', '1.2em')
                    .text(label.slice(0, -1)); // remove last space caracter
    
                label = '';
            }
        })
        .attr('font-size', graphProperties.text_size)
        .attr('x', 0)
        .attr('y', (d) => d.size)
        .attr('dominant-baseline', 'middle')
        .attr('text-anchor', 'middle');

    link.attr("class", (d) => 'l_' + d.type)
        .attr("data-source", (d) => d.source)
        .attr("data-target", (d) => d.target)
        .attr("stroke-dasharray", function(d) {
            if (d.shape.stroke === 'dash' || d.shape.stroke === 'dotted') {
                return d.shape.dashInterval }
            return false;
        })
        .attr("filter", function(d) {
            if (d.shape.stroke === 'double') {
                return 'url(#double)' }
            return false;
        });

    if (graphProperties.arrows === true) {
        link.attr("marker-end", 'url(#arrow)');
    }
}

/**
 * Update elements position
 */

 function ticked() {
    link.attr("x1", (d) => d.source.x)
        .attr("y1", (d) => d.source.y)
        .attr("x2", (d) => d.target.x)
        .attr("y2", (d) => d.target.y);

    node.attr("transform", function(d) {
        d.x = Math.max(d.size, Math.min(width - d.size, d.x));
        d.y = Math.max(d.size, Math.min(height - d.size, d.y));

        return "translate(" + d.x + "," + d.y + ")";
    })

    d3.select('#load-bar-value').style('flex-basis', (simulation.alpha() * 100) + '%');
}

/**
 * Get nodes and their links
 * @param {array} nodeIds - List of nodes ids
 * @returns {array} - DOM elts : nodes and their links
 */

function getNodeNetwork(nodeIds) {
    const diplayedNodes = graph.nodes.filter(item => item.hidden === false)
        .map(item => item.id);

    const nodes = node.filter(node => nodeIds.includes(node.id));

    const links = link.filter(function(link) {
        if (!nodeIds.includes(link.source.id) &amp;&amp; !nodeIds.includes(link.target.id)) {
            return false; }
        if (!diplayedNodes.includes(link.source.id) || !diplayedNodes.includes(link.target.id)) {
            return false; }

        return true;
    });

    return {
        nodes: nodes,
        links: links
    }
}

/**
 * Display none nodes and their link
 * @param {array} nodeIds - List of nodes ids
 */

function hideNodeNetwork(nodeIds) {
    const ntw = getNodeNetwork(nodeIds);

    ntw.nodes.style('display', 'none');
    ntw.links.style('display', 'none');
}

window.hideNodeNetwork = hideNodeNetwork;

/**
 * Reset display nodes and their link
 * @param {array} nodeIds - List of nodes ids
 */

function displayNodeNetwork(nodeIds) {
    const ntw = getNodeNetwork(nodeIds);

    ntw.nodes.style('display', null);
    ntw.links.style('display', null);
}

window.displayNodeNetwork = displayNodeNetwork;

/**
 * Apply highlightColor (from config) to somes nodes and their links
 * @param {array} nodeIds - List of nodes ids
 */

function highlightNodes(nodeIds) {
    const ntw = getNodeNetwork(nodeIds);

    ntw.nodes.classed('highlight', true);
    ntw.links.classed('highlight', true);

    view.highlightedNodes = view.highlightedNodes.concat(nodeIds);
}

window.highlightNodes = highlightNodes;

/**
 * remove highlightColor from all highlighted nodes and their links
 */

function unlightNodes() {
    if (view.highlightedNodes.length === 0) { return; }

    const ntw = getNodeNetwork(view.highlightedNodes);

    ntw.nodes.classed('highlight', false);
    ntw.links.classed('highlight', false);

    view.highlightedNodes = [];
}

window.unlightNodes = unlightNodes;

/**
 * Toggle display/hide nodes links
 * @param {bool} isChecked - 'checked' value send by a checkbox input
 */

function linksDisplayToggle(isChecked) {
    if (isChecked) {
        link.style('display', null);
    } else {
        link.style('display', 'none');
    }
}

window.linksDisplayToggle = linksDisplayToggle;

/**
 * Toggle display/hide nodes label
 * @param {bool} isChecked - 'checked' value send by a checkbox input
 */

function labelDisplayToggle(isChecked) {
    if (isChecked) {
        labels.style('display', null);
    } else {
        labels.style('display', 'none');
    }
}

window.labelDisplayToggle = labelDisplayToggle;

/**
 * Add 'highlight' class to texts linked to nodes ids
 * @param {array} nodeIds - List of node ids
 */

function labelHighlight(nodeIds) {
    const labelsToHighlight = node
        .filter(node => nodeIds.includes(node.id)).select('text');

    graph.nodes = graph.nodes.map(function(node) {
        if (nodeIds.includes(node.id)) {
            node.highlighted = true; }
        return node;
    });

    labelsToHighlight.classed('highlight', true);
}

window.labelHighlight = labelHighlight;

/**
 * Remove 'highlight' class from texts linked to nodes ids
 * @param {array} nodeIds - List of node ids
 */

function labelUnlight(nodeIds) {
    const labelsToHighlight = node
        .filter(node => nodeIds.includes(node.id)).select('text');

    graph.nodes = graph.nodes.map(function(node) {
        if (nodeIds.includes(node.id)) {
            node.highlighted = false; }
        return node;
    });

    labelsToHighlight.classed('highlight', false);
}

window.labelUnlight = labelUnlight;

/**
 * Remove 'highlight' class from all texts
 */

function labelUnlightAll() {
    graph.nodes = graph.nodes.map(function(node) {
        node.highlighted = false;
        return node;
    });

    labels.classed('highlight', false);
}

window.labelUnlightAll = labelUnlightAll;

})();</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Fri Jun 18 2021 18:03:03 GMT+0200 (GMT+02:00) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
